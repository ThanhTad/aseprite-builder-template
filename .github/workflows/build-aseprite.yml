name: Build Aseprite (Windows Fixed)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout Aseprite source
        uses: actions/checkout@v4
        with:
          repository: aseprite/aseprite
          submodules: recursive

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Ninja
        run: choco install ninja

      - name: Cache Skia
        id: cache-skia
        uses: actions/cache@v4
        with:
          path: deps/skia
          key: skia-windows-m124-08a5439a6b

      - name: Download Skia (Windows x64)
        if: steps.cache-skia.outputs.cache-hit != 'true'
        run: |
          URL="https://github.com/aseprite/skia/releases/download/m124-08a5439a6b/Skia-Windows-Release-x64.zip"
          echo "Downloading Skia..."
          curl -L "$URL" -o skia.zip
          mkdir -p deps/skia
          unzip skia.zip -d deps/skia
          rm skia.zip

      - name: CMake Configure
        run: |
          ROOT_PATH=$(pwd -W)
          SKIA_PATH="$ROOT_PATH/deps/skia"
          
          echo "Using Skia Path: $SKIA_PATH"
          
          mkdir -p build
          cd build
          
          cmake .. -G Ninja \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DLAF_BACKEND=skia \
            -DSKIA_DIR="$SKIA_PATH" \
            -DSKIA_LIBRARY_DIR="$SKIA_PATH/out/Release-x64"

      - name: Build Aseprite
        run: cd build && ninja

      - name: Package
        run: |
          cd build/bin
          ASE_VER=$(grep -oP 'ASEPRITE_VERSION "\K[^"]+' ../../src/ver/ver.h || echo "dev")
          ZIP_NAME="Aseprite-${ASE_VER}-Windows.zip"
          
          mkdir -p packag
          cp aseprite.exe package/
          cp -r ../../data package/
          
          7z a -tzip "${ZIP_NAME}" ./package/*
          echo "ASSET_PATH=build/bin/${ZIP_NAME}" >> $GITHUB_ENV

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ASSET_PATH }}
          tag_name: latest-windows
          name: Aseprite Windows Build
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
